{% extends "layout.html" %}
{% block content %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detalle_cobro.css') }}">
{% endblock %}

<div class="cobro-header">
    <h2>Detalle de Cobro - Factura #{{ factura.id_factura_venta }}</h2>
    <a href="/cobros" class="btn btn-secondary">← Volver a Cobros</a>
</div>

<div class="factura-info">
    <div class="info-section">
        <h3>Cliente</h3>
        <p><strong>{{ factura.cliente_nombre }} {{ factura.cliente_apellido or '' }}</strong></p>
        <p>📞 {{ factura.cliente_telefono or 'Sin teléfono' }}</p>
        <p>📍 {{ factura.cliente_direccion or 'Sin dirección' }}</p>
        {% if factura.cliente_dui %}
        <p>🆔 DUI: {{ factura.cliente_dui }}</p>
        {% endif %}
    </div>
    
    <div class="info-section">
        <h3>Producto</h3>
        <p><strong>{{ factura.producto_nombre }}</strong></p>
        {% if factura.producto_descripcion %}
        <p>{{ factura.producto_descripcion }}</p>
        {% endif %}
        <p>💰 Precio Unitario: ${{ "%.2f"|format(factura.precio_producto) }}</p>
        <p>Cantidad: {{ factura.cantidad }}</p>  
        <p>📅 Fecha venta: {{ factura.fecha_venta.strftime('%d/%m/%Y') if factura.fecha_venta.strftime else factura.fecha_venta }}</p>
    </div>
    
    <div class="info-section payment-summary">
        <h3>Resumen de Pago</h3>
        <div class="payment-details">
            <div class="payment-item">
                <span>Total:</span>
                <span class="amount">${{ "%.2f"|format(factura.total) }}</span>
            </div>
            <div class="payment-item">
                <span>Abonado:</span>
                <span class="amount abonado">${{ "%.2f"|format(factura.monto_abonado) }}</span>
            </div>
            <div class="payment-item destacado">
                <span>Saldo Pendiente:</span>
                <span class="amount saldo">${{ "%.2f"|format(factura.saldo_pendiente) }}</span>
            </div>
            <div class="payment-item">
                <span>Estado:</span>
                <span class="estado-badge {{ factura.estado_pago }}">{{ factura.estado_pago.title() }}</span>
            </div>
            {% if factura.es_credito %}
            <div class="payment-item">
                <span>Cuotas:</span>
                <span>{{ factura.cuotas }} meses</span>
            </div>
            <div class="payment-item">
                <span>Pago mensual:</span>
                <span class="amount">${{ "%.2f"|format(factura.precio_mensual) }}</span>
            </div>
            {% endif %}
        </div>
        
    </div>
</div>

{% if meses_pago and factura.es_credito %}
<div class="meses-pago">
    <h3>📊 Estado de Pagos por Mes</h3>
    <div class="meses-grid">
        {% for mes in meses_pago %}
        <div class="mes-card {{ mes.estado }}">
            <div class="mes-header">
                <h4>{{ mes.mes_nombre }}</h4>
                <span class="cuota-numero">Cuota {{ mes.numero }}</span>
            </div>
            
            <div class="mes-info">
                <div class="info-row">
                    <span>Esperado:</span>
                    <span class="amount">${{ "%.2f"|format(mes.cuota_esperada) }}</span>
                </div>
                <div class="info-row">
                    <span>Abonado:</span>
                    <span class="amount abonado">${{ "%.2f"|format(mes.total_abonado) }}</span>
                </div>
                <div class="info-row">
                    <span>Pendiente:</span>
                    <span class="amount pendiente">${{ "%.2f"|format(mes.pendiente) }}</span>
                </div>
            </div>
            
            {% if mes.abonos %}
            <div class="abonos-detalle">
                <small>Abonos registrados:</small>
                {% for abono in mes.abonos %}
                <div class="abono-item">
                    <span>${{ "%.2f"|format(abono.monto) }}</span>
                    <small>{{ abono.fecha.strftime('%d/%m') if abono.fecha.strftime else abono.fecha }}</small>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if historial %}
<div class="historial-abonos">
    <h3>📋 Historial de Abonos</h3>
    <div class="historial-tabla">
        <table class="tabla-abonos">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Monto</th>
                    <th>Mes/Año</th>
                    <th>Saldo Después</th>
                    <th>Observaciones</th>
                    <th>Registrado por</th>
                    <th>acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for abono in historial %}
                <tr>
                    <td>{{ abono.fecha.strftime('%d/%m/%Y') if abono.fecha.strftime else abono.fecha }}</td>
                    <td class="amount">${{ "%.2f"|format(abono.monto_abonado) }}</td>
                    <td>{{ abono.mes_correspondiente }}/{{ abono.año_correspondiente }}</td>
                    <td class="amount">${{ "%.2f"|format(abono.saldo_pendiente) }}</td>
                    <td>{{ abono.observaciones or '-' }}</td>
                    <td>{{ abono.usuario_registro or 'Sistema' }}</td>
                </tr>
                <td>
                    <div class="acciones-recibo">
                        <a href="/ver_recibo/{{ abono.id_abono }}" class="btn-recibo ver" target="_blank" title="Ver recibo">TarjetaDeControl👁️</a>
                        <a href="/generar_recibo/{{ abono.id_abono }}" class="btn-recibo descargar" title="Descargar recibo">TarjetaDeControl📄</a>
                    </div>
                </td>
                
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="no-historial">
    <p>📝 No hay abonos registrados para esta factura</p>
</div>
{% endif %}


{% endblock %}