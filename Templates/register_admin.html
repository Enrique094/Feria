{% extends "layout.html" %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Registrar Usuario</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Admin_Usuarios.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/New_usuariosAdmin.css') }}">
    <script>
        function mostrarCampos() {
            const valor = document.getElementById("rango").value;
            document.getElementById("campos_cliente").style.display = valor == "2" ? "block" : "none";
            document.getElementById("campos_vendedor").style.display = valor == "3" ? "block" : "none";
            document.getElementById("campos_cobrador").style.display = valor == "4" ? "block" : "none";
        }
    </script>
</head>

<h2 class="titulo-registro">Registrar Usuario</h2>

{% if request.args.get('registro') == 'exitoso' %}
    <p class="mensaje-exito">✅ Usuario registrado correctamente.</p>
{% elif request.args.get('error') == 'correo_existente' %}
    <p class="mensaje-error">❌ Este correo ya está registrado.</p>
{% elif request.args.get('error') == 'fallo_en_registro' %}
    <p class="mensaje-error">❌ Error inesperado al registrar usuario.</p>
{% endif %}

<form action="/register_admin" method="POST" class="registro-usuario">
    <input class="input-registro" type="text" name="nombre" placeholder="Nombre completo" required />
    <input class="input-registro" type="email" name="correo" placeholder="Correo electrónico" required />
    <input class="input-registro" type="password" name="contraseña" placeholder="Contraseña" required minlength="8" />

    <select class="select-registro" name="rango" id="rango" onchange="mostrarCampos()" required>
        <option value="" disabled selected>Selecciona un rango</option>
        {% for rango in rangos %}
            <option value="{{ rango.id_rango }}">{{ rango.nombre }}</option>
        {% endfor %}
    </select>

    <!-- Cliente -->
    <div id="campos_cliente" class="campos-extra" style="display: none;">
      <h3>Datos de Cliente</h3>
    <br>
    <label for="cliente_apellido">Apellidos</label>
    <input type="text" name="cliente_apellido" placeholder="Apellido" class="input-registro" />
    <br>
    <label for="cliente_tel">Teléfono</label>
    <input type="text" name="cliente_tel" placeholder="00000000" class="input-registro" />
    <br>
    <label for="cliente_dui">DUI</label>
    <input type="text" name="cliente_dui" placeholder="00000000-0" class="input-registro" />
    <br>
    <label for="cliente_direccion">Dirección</label>
    <input type="text" name="cliente_direccion" placeholder="San Salvador, Apopa" class="input-registro" />
    </div>

    <!-- Vendedor -->
    <div id="campos_vendedor" class="campos-extra" style="display: none;">
        <h3>Datos de Vendedor</h3>
        <br>
        <label>Apellidos</label>
        <input class="input-registro" type="text" name="vendedor_apellido" placeholder="Apellido" />
        <br>
        <label>Teléfono</label>
        <input class="input-registro" type="text" name="vendedor_tel" placeholder="00000000" minlength="8" maxlength="9" />
        <br>
        <label>Zona</label>
        <select class="select-registro" name="vendedor_zona">
            <option value="" disabled selected>Selecciona una zona</option>
            {% for zona in zonas %}
                <option value="{{ zona.id_zona }}">{{ zona.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Cobrador -->
    <div id="campos_cobrador" class="campos-extra" style="display: none;">
        <h3>Datos de Cobrador</h3>
        <br>
        <label>Apellidos</label>

        <input class="input-registro" type="text" name="cobrador_apellido" placeholder="Apellido" />
        <br>
        <label>Teléfono</label>
        <input class="input-registro" type="text" name="cobrador_tel" placeholder="00000000" minlength="8" maxlength="9" />
        <br>
        <label>Zona</label>
        <select class="select-registro" name="cobrador_zona">
            <option value="" disabled selected>Selecciona una zona</option>
            {% for zona in zonas %}
                <option value="{{ zona.id_zona }}">{{ zona.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <button class="btn-registro" type="submit">Registrar</button>
</form>
<hr><br>
<h2>Usuarios registrados</h2>

<input class="search" 
  type="text"
  id="searchInput"
  onkeyup="filtrarUsuarios()"
  placeholder="Buscar usuarios..."
/>

{% for user in users %}
  <form action="/editar_usuario" method="POST" class="formulario_update" style="margin-bottom: 15px;">
    <input type="hidden" name="user_id" value="{{ user.id }}" />
    <input type="text" name="nombre" value="{{ user.nombre }}" required />
    <input type="email" name="correo" value="{{ user.correo }}" required />

    <select name="estado">
        <option value="1" {% if user.estado == 1 %}selected{% endif %}>Activo</option>
        <option value="0" {% if user.estado == 0 %}selected{% endif %}>Inactivo</option>
    </select>

    <select name="rango">
        {% for rango in rangos %}
            <option value="{{ rango.id_rango }}" {% if user.id_rango == rango.id_rango %}selected{% endif %}>
                {{ rango.nombre }}
            </option>
        {% endfor %}
    </select>

    <button type="submit">Actualizar</button>
    <a href="#" onclick="eliminarUsuario('{{ user.id }}')" class="btn-eliminar">Eliminar</a>
  </form>
{% endfor %}

<script>
  function eliminarUsuario(userId) {
    if (confirm('¿Seguro que quieres eliminar este usuario?')) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/eliminar_usuario/${userId}`;
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>
<script>
  function filtrarUsuarios() {
    const termino = document.getElementById('searchInput').value.toLowerCase();
    const formularios = document.querySelectorAll('.formulario_update');

    formularios.forEach(form => {
      const nombre = form.querySelector('input[name="nombre"]').value.toLowerCase();
      const correo = form.querySelector('input[name="correo"]').value.toLowerCase();
      if (nombre.includes(termino) || correo.includes(termino)) {
        form.style.display = '';
      } else {
        form.style.display = 'none';
      }
    });
  }
</script>


{% endblock %}