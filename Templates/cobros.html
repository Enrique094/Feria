{% extends "layout.html" %}
{% block content %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cobros.css') }}">
{% endblock %}

<h2>Sistema de Cobros - {{ session.nombre }}</h2>

<div class="resumen-cobros">
    <div class="stat-card">
        <h3>Total Ventas</h3>
        <span>{{ ventas|length }}</span>
    </div>
    <div class="stat-card">
        <h3>Pendientes</h3>
        <span>
        {% set pendientes = ventas | selectattr("estado_pago", "equalto", "pendiente") | list %}
        {{ pendientes|length }}
        </span>
    </div>
    <div class="stat-card">
        <h3>Parciales</h3>
        <span>
        {% set parciales = ventas | selectattr("estado_pago", "equalto", "parcial") | list %}
        {{ parciales|length }}
        </span>
    </div>
    <div class="stat-card">
        <h3>Pagadas</h3>
        <span>
        {% set pagadas = ventas | selectattr("estado_pago", "equalto", "pagado") | list %}
        {{ pagadas|length }}
        </span>
    </div>
</div>

<div class="ventas-container">
    {% if ventas %}
        <table class="ventas-table">
            <thead>
                <tr>
                    <th>Factura</th>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Tipo</th>
                    <th>Total</th>
                    <th>Abonado</th>
                    <th>Saldo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for venta in ventas %}
                <tr class="venta-row {{ venta.estado_pago }}">
                    <td>
                        <strong>#{{ venta.id_factura_venta }}</strong><br>
                        <small>{{ venta.fecha_venta.strftime('%d/%m/%Y') if venta.fecha_venta.strftime else venta.fecha_venta }}</small>
                    </td>
                    <td>
                        <strong>{{ venta.cliente_nombre }} {{ venta.cliente_apellido or '' }}</strong><br>
                        <small>{{ venta.cliente_telefono or 'Sin teléfono' }}</small>
                    </td>
                    <td>{{ venta.producto_nombre }}</td>
                    <td class="cantidad">{{ venta.cantidad }}</td>
                    <td>
                        <span class="tipo-badge {{ 'credito' if venta.tipo_pago == 'Crédito' else 'contado' }}">
                            {{ venta.tipo_pago }}
                        </span>
                    </td>
                    <td class="monto">${{ "%.2f"|format(venta.total) }}</td>
                    <td class="monto">${{ "%.2f"|format(venta.monto_abonado) }}</td>
                    <td class="monto saldo">${{ "%.2f"|format(venta.saldo_pendiente) }}</td>
                    <td>
                        <span class="estado-badge {{ venta.estado_pago }}">
                            {{ venta.estado_pago.title() }}
                        </span>
                    </td>
                    <td>
                        <div class="acciones">
                            <a href="/detalle_cobro/{{ venta.id_factura_venta }}" class="btn btn-primary">
                                Ver Detalle
                            </a>
                            {% if venta.estado_pago != 'pagado' %}
                            <a href="/registrar_abono/{{ venta.id_factura_venta }}" class="btn btn-success">
                                Registrar Abono
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="no-ventas">
            <h3>No tienes ventas asignadas</h3>
            <p>Contacta con el administrador para que te asignen ventas para cobrar.</p>
        </div>
    {% endif %}
</div>


{% endblock %}