{% extends "layout.html" %}
{% block content %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mis_compras.css') }}">
{% endblock %}

<div class="cliente-header">
    <h2>Mis Compras - {{ session.nombre }}</h2>
    <p class="cliente-info">Aqu√≠ puedes ver todas tus compras, estados de pago y realizar seguimiento a tus pagos.</p>
</div>

<!-- Resumen de estad√≠sticas -->
<div class="estadisticas-cliente">
    <div class="stat-card total">
        <div class="stat-icon">üõçÔ∏è</div>
        <div class="stat-info">
            <h3>{{ estadisticas.total_compras }}</h3>
            <p>Total Compras</p>
        </div>
    </div>
    <div class="stat-card pagadas">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
            <h3>{{ estadisticas.compras_pagadas }}</h3>
            <p>Pagadas</p>
        </div>
    </div>
    <div class="stat-card pendientes">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-info">
            <h3>{{ estadisticas.compras_pendientes }}</h3>
            <p>Pendientes</p>
        </div>
    </div>
    <div class="stat-card gastado">
        <div class="stat-icon">üí∞</div>
        <div class="stat-info">
            <h3>${{ "%.2f"|format(estadisticas.total_gastado) }}</h3>
            <p>Total Gastado</p>
        </div>
    </div>
    <div class="stat-card deuda">
        <div class="stat-icon">üìä</div>
        <div class="stat-info">
            <h3>${{ "%.2f"|format(estadisticas.total_pendiente) }}</h3>
            <p>Saldo Pendiente</p>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="filtros-compras">
    <button class="filtro-btn active" onclick="filtrarCompras('todas')">Todas</button>
    <button class="filtro-btn" onclick="filtrarCompras('pendiente')">Pendientes</button>
    <button class="filtro-btn" onclick="filtrarCompras('parcial')">Parciales</button>
    <button class="filtro-btn" onclick="filtrarCompras('pagado')">Pagadas</button>
    <button class="filtro-btn" onclick="filtrarCompras('credito')">A Cr√©dito</button>
</div>

<!-- Lista de compras -->
<div class="compras-container">
    {% if compras %}
        {% for compra in compras %}
        <div class="compra-card {{ compra.estado_pago }}" data-estado="{{ compra.estado_pago }}" data-tipo="{{ 'credito' if compra.es_credito else 'contado' }}">
            <div class="compra-header">
                <div class="compra-info">
                    <h3>{{ compra.producto_nombre }}{% if compra.cantidad > 1 %} <span class="cantidad-badge">x{{ compra.cantidad }}</span>{% endif %}</h3>
                    <p class="fecha">üìÖ {{ compra.fecha_compra.strftime('%d/%m/%Y') if compra.fecha_compra.strftime else compra.fecha_compra }}</p>
                    <span class="factura-num">Factura #{{ compra.id_factura_venta }}</span>
                </div>
                <div class="compra-estado">
                    <span class="estado-badge {{ compra.estado_pago }}">
                        {{ compra.estado_pago.title() }}
                    </span>
                    <span class="tipo-badge {{ 'credito' if compra.es_credito else 'contado' }}">
                        {{ 'Cr√©dito' if compra.es_credito else 'Contado' }}
                    </span>
                </div>
            </div>
            
            <div class="compra-detalles">
                <div class="detalle-item">
                    <span class="label">Producto:</span>
                    <span class="valor">{{ compra.producto_nombre }}{% if compra.cantidad > 1 %} (x{{ compra.cantidad }}){% endif %}</span>
                </div>
                <div class="detalle-item">
                    <span class="label">Total:</span>
                    <span class="valor total">${{ "%.2f"|format(compra.total) }}</span>
                </div>
                <div class="detalle-item">
                    <span class="label">Abonado:</span>
                    <span class="valor abonado">${{ "%.2f"|format(compra.monto_abonado) }}</span>
                </div>
                <div class="detalle-item">
                    <span class="label">Pendiente:</span>
                    <span class="valor pendiente">${{ "%.2f"|format(compra.saldo_pendiente) }}</span>
                </div>
                {% if compra.es_credito %}
                <div class="detalle-item">
                    <span class="label">Cuotas:</span>
                    <span class="valor">{{ compra.cuotas }} meses</span>
                </div>
                <div class="detalle-item">
                    <span class="label">Pago mensual:</span>
                    <span class="valor">${{ "%.2f"|format(compra.precio_mensual) }}</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Barra de progreso -->
            {% if compra.es_credito and compra.total > 0 %}
            <div class="progreso-pago">
                {% set porcentaje = (compra.monto_abonado / compra.total * 100) %}
                <div class="progreso-bar">
                    <div class="progreso-fill {{ compra.estado_pago }}" {{ porcentaje }}%"></div>
                </div>
                <span class="progreso-texto">{{ "%.1f"|format(porcentaje) }}% pagado</span>
            </div>
            {% endif %}
            
            <div class="compra-acciones">
                <a href="/detalle_compra/{{ compra.id_factura_venta }}" class="btn btn-primary">
                    Ver Detalle Completo
                </a>
                {% if compra.estado_pago != 'pagado' and compra.es_credito %}
                <span class="estado-info">
                    üí° Pr√≥ximo pago: ${{ "%.2f"|format(compra.precio_mensual) }}
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-compras">
            <div class="no-compras-icon">üõí</div>
            <h3>No tienes compras registradas</h3>
            <p>Cuando realices compras, aparecer√°n aqu√≠ para que puedas hacer seguimiento a tus pagos.</p>
        </div>
    {% endif %}
</div>

<script>
function filtrarCompras(filtro) {
    const compras = document.querySelectorAll('.compra-card');
    const botones = document.querySelectorAll('.filtro-btn');
    
    // Actualizar bot√≥n activo
    botones.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    compras.forEach(compra => {
        let mostrar = false;
        
        switch(filtro) {
            case 'todas':
                mostrar = true;
                break;
            case 'credito':
                mostrar = compra.dataset.tipo === 'credito';
                break;
            default:
                mostrar = compra.dataset.estado === filtro;
        }
        
        compra.style.display = mostrar ? 'block' : 'none';
    });
}
</script>

<style>
/* Estilos para la secci√≥n del cliente */
.cliente-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
}

.cliente-header h2 {
    margin: 0 0 10px 0;
    font-size: 28px;
}

.cliente-info {
    margin: 0;
    opacity: 0.9;
}

.estadisticas-cliente {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    font-size: 24px;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
}

.stat-card.total .stat-icon { background: #e3f2fd; }
.stat-card.pagadas .stat-icon { background: #e8f5e8; }
.stat-card.pendientes .stat-icon { background: #fff3e0; }
.stat-card.gastado .stat-icon { background: #f3e5f5; }
.stat-card.deuda .stat-icon { background: #ffebee; }

.stat-info h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: #2c3e50;
}

.stat-info p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
    font-size: 14px;
}

.filtros-compras {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.filtro-btn {
    padding: 10px 20px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.filtro-btn:hover,
.filtro-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.compras-container {
    display: grid;
    gap: 20px;
}

.compra-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.2s, box-shadow 0.2s;
}

.compra-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.compra-card.pendiente { border-color: #dc3545; }
.compra-card.parcial { border-color: #ffc107; }
.compra-card.pagado { border-color: #28a745; }

.compra-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.compra-info h3 {
    margin: 0 0 8px 0;
    color: #2c3e50;
    font-size: 20px;
}

.fecha {
    margin: 0 0 5px 0;
    color: #6c757d;
    font-size: 14px;
}

.factura-num {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    color: #495057;
}

.compra-estado {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.estado-badge, .tipo-badge {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    text-align: center;
}

.estado-badge.pendiente { background: #f8d7da; color: #721c24; }
.estado-badge.parcial { background: #fff3cd; color: #856404; }
.estado-badge.pagado { background: #d4edda; color: #155724; }

.tipo-badge.credito { background: #e7f3ff; color: #0066cc; }
.tipo-badge.contado { background: #e8f5e8; color: #2d6a2d; }

.compra-detalles {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.detalle-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.label {
    font-size: 14px;
    color: #6c757d;
}

.valor {
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

.valor.total { color: #2c3e50; }
.valor.abonado { color: #28a745; }
.valor.pendiente { color: #dc3545; }

.progreso-pago {
    margin: 20px 0;
}

.progreso-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progreso-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.progreso-fill.pendiente { background: #dc3545; }
.progreso-fill.parcial { background: #ffc107; }
.progreso-fill.pagado { background: #28a745; }

.progreso-texto {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

.compra-acciones {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    cursor: pointer;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.estado-info {
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
}

.no-compras {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.no-compras-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.no-compras h3 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.no-compras p {
    color: #6c757d;
}

/* Responsivo */
@media (max-width: 768px) {
    .estadisticas-cliente {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .compra-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .compra-estado {
        flex-direction: row;
    }
    
    .compra-detalles {
        grid-template-columns: 1fr;
    }
    
    .compra-acciones {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    
    .filtros-compras {
        justify-content: center;
    }
}
</style>

{% endblock %}